{% extends "base.html" %}

{% block title %}Scene {{ scene.order }} — {{ act.title if act.title else "Act " ~ act.order }} — {{ game.name }} — Loom{% endblock %}

{% block content %}
<h1>{{ game.name }} &mdash; {{ act.title if act.title else "Act " ~ act.order }} &mdash; Scene {{ scene.order }}</h1>

<nav>
    <strong>Nav:</strong>
    <a href="/games/{{ game.id }}">Dashboard</a> |
    <a href="/games/{{ game.id }}/acts">Acts</a> |
    <a href="/games/{{ game.id }}/acts/{{ act.id }}/scenes">Scenes</a> |
    <a href="/games/{{ game.id }}/characters">Characters</a> |
    <a href="/games/{{ game.id }}/safety-tools">Safety Tools</a> |
    <a href="/games/{{ game.id }}/world-document">World Doc</a>
</nav>

<section style="margin-top:1.5rem; padding:1rem; border:1px solid #ccc; border-radius:4px; background:#fafafa;">
  <h2 style="margin-top:0;">Scene {{ scene.order }}: {{ scene.guiding_question }}</h2>
  {% if scene.location %}
  <p><strong>Location:</strong> {{ scene.location }}</p>
  {% endif %}
  <p>
    <strong>Tension:</strong>
    <span style="font-size:1.2rem; font-weight:bold; color:{% if scene.tension >= 7 %}#c04000{% elif scene.tension >= 4 %}#c07800{% else %}#2a7a2a{% endif %};">
      {{ scene.tension }}
    </span>
    {% if scene.tension_carry_forward is not none and scene.tension_carry_forward != scene.tension %}
      &rarr;
      <span style="font-size:1.2rem; font-weight:bold; color:{% if scene.tension_carry_forward >= 7 %}#c04000{% elif scene.tension_carry_forward >= 4 %}#c07800{% else %}#2a7a2a{% endif %};">
        {{ scene.tension_carry_forward }}
      </span>
      <em style="font-size:0.85em; color:#666;">after scene</em>
    {% endif %}
    / 9
    &nbsp;&mdash;&nbsp;
    <strong>Status:</strong> {{ scene.status.value | capitalize }}
  </p>
  {% if scene.characters_present %}
  <p>
    <strong>Characters present:</strong>
    {% for char in scene.characters_present %}
      {%- if active_spotlight and active_spotlight.waiting_for_character_id == char.id %}
        <span style="background:#fff3cd; border:1px solid #e0c060; border-radius:3px; padding:0 0.35rem; font-weight:bold;">&#x23F3; {{ char.name }}</span>
      {%- else %}{{ char.name }}{%- endif %}
      {%- if not loop.last %}, {% endif %}
    {% endfor %}
  </p>
  {% endif %}
</section>

{% if nudge %}
<div style="margin-top:1rem; padding:0.6rem 1rem; background:#fff8e0; border:1px solid #e0c060; border-radius:4px; font-size:0.9rem;">
  You've posted the last {{ nudge }} beat{{ 's' if nudge != 1 else '' }} — maybe see if others want to jump in?
</div>
{% endif %}

{% if active_spotlight and active_spotlight.waiting_for_character %}
<div style="margin-top:1rem; padding:0.6rem 1rem; background:#fff4e0; border:1px solid #d09030; border-radius:4px; font-size:0.9rem;">
  &#x23F3; <strong>{{ active_spotlight.waiting_for_character.name }}</strong> is in the spotlight &mdash; someone is waiting for a response.
  {% if active_spotlight.spotlight_expires_at %}
  <span style="color:#888; font-size:0.82rem;">(Expires after the silence timer.)</span>
  {% endif %}
</div>
{% endif %}

<section style="margin-top:1.5rem;">
  <h2>Beat Timeline</h2>

  <nav style="margin-bottom:0.75rem;">
    <strong>Filter:</strong>
    <a href="?filter=all"{% if filter == "all" %} style="font-weight:bold;" aria-current="page"{% endif %}>All</a> |
    <a href="?filter=ic"{% if filter == "ic" %} style="font-weight:bold;" aria-current="page"{% endif %}>IC Only</a> |
    <a href="?filter=ooc"{% if filter == "ooc" %} style="font-weight:bold;" aria-current="page"{% endif %}>OOC Only</a>
  </nav>

  <div
    id="beat-timeline"
    hx-get="/games/{{ game.id }}/acts/{{ act.id }}/scenes/{{ scene.id }}/beats?filter={{ filter }}"
    hx-trigger="every 5s"
    hx-target="#beat-timeline"
    hx-swap="innerHTML"
  >
    {% include "_beats_partial.html" %}
  </div>
  <script>
  (function () {
    var openSummaries = [];
    var tl = document.getElementById('beat-timeline');
    tl.addEventListener('htmx:beforeSwap', function () {
      openSummaries = Array.from(tl.querySelectorAll('details[open] summary')).map(function (s) {
        return s.textContent.trim();
      });
    });
    tl.addEventListener('htmx:afterSwap', function () {
      if (!openSummaries.length) return;
      tl.querySelectorAll('details summary').forEach(function (s) {
        if (openSummaries.indexOf(s.textContent.trim()) !== -1) {
          s.parentElement.open = true;
        }
      });
      openSummaries = [];
    });
  })();
  </script>
</section>

<section style="margin-top:1.5rem; border-top:1px solid #ddd; padding-top:1rem;">
  <h2>Scene Completion</h2>
  {% if scene_complete_proposal %}
  <p><strong>Proposed by:</strong> {{ scene_complete_proposal.proposed_by.display_name if scene_complete_proposal.proposed_by else "Unknown" }}</p>
  <p>
    <strong>Votes:</strong> {{ sc_yes_count }} yes &middot; {{ sc_no_count }} no &middot; {{ sc_suggest_count }} suggestion(s)
    &nbsp;({{ total_players }} player{{ "s" if total_players != 1 else "" }} total,
    threshold: more than {{ threshold | int if threshold == (threshold | int) else threshold }})
  </p>
  {% if scene_complete_proposal.votes %}
  <ul>
    {% for v in scene_complete_proposal.votes %}
    <li>
      <strong>{{ v.voter.display_name if v.voter else "Anonymous" }}:</strong>
      {{ v.choice.value | replace("_", " ") | capitalize }}
      {% if v.suggestion %}<br><em style="color:#555;">Suggestion: {{ v.suggestion }}</em>{% endif %}
    </li>
    {% endfor %}
  </ul>
  {% endif %}
  {% if not sc_my_vote %}
  <form method="post" action="/games/{{ game.id }}/proposals/{{ scene_complete_proposal.id }}/vote" style="margin-top:0.75rem;">
    <fieldset>
      <legend><strong>Cast your vote</strong></legend>
      <label style="display:block; margin:0.4rem 0;"><input type="radio" name="choice" value="yes" required> Yes, complete the scene</label>
      <label style="display:block; margin:0.4rem 0;"><input type="radio" name="choice" value="no"> No, keep it open</label>
      <label style="display:block; margin:0.4rem 0;"><input type="radio" name="choice" value="suggest_modification"> Suggest modification</label>
      <div style="margin-top:0.5rem;">
        <label for="sc_suggestion">Suggestion (optional):</label><br>
        <textarea id="sc_suggestion" name="suggestion" rows="2" style="width:100%; box-sizing:border-box;"></textarea>
      </div>
      <button type="submit" style="margin-top:0.5rem;">Submit vote</button>
    </fieldset>
  </form>
  {% else %}
  <p>Your vote: <strong>{{ sc_my_vote.choice.value | replace("_", " ") | capitalize }}</strong>
  {% if sc_my_vote.suggestion %} &mdash; <em>{{ sc_my_vote.suggestion }}</em>{% endif %}</p>
  {% endif %}
  {% elif scene.status.value == "active" %}
  <form method="post" action="/games/{{ game.id }}/acts/{{ act.id }}/scenes/{{ scene.id }}/complete">
    <button type="submit">Propose Scene Completion</button>
  </form>
  {% else %}
  <p style="color:#888; font-style:italic;">This scene is complete.</p>
  {% endif %}
</section>

{% if tension_adj_proposal %}
<section style="margin-top:1.5rem; border-top:1px solid #ddd; padding-top:1rem;">
  <h2>Tension Adjustment</h2>
  <p>
    <strong>AI recommendation:</strong>
    {% if tension_adj_proposal.tension_delta == 1 %}
      +1 — Escalate
    {% elif tension_adj_proposal.tension_delta == -1 %}
      -1 — Ease tension
    {% else %}
      0 — Hold steady
    {% endif %}
  </p>
  <blockquote style="margin:0.75rem 0; padding:0.5rem 1rem; border-left:3px solid #ccc; color:#444; font-style:italic;">
    {{ tension_adj_proposal.ai_rationale }}
  </blockquote>
  <p>
    <strong>Current tension:</strong>
    <span style="font-weight:bold; color:{% if scene.tension >= 7 %}#c04000{% elif scene.tension >= 4 %}#c07800{% else %}#2a7a2a{% endif %};">
      {{ scene.tension }}
    </span>
    / 9
    &nbsp;&rarr;&nbsp;
    <strong>If accepted:</strong>
    <span style="font-weight:bold; color:{% if ta_proposed_tension >= 7 %}#c04000{% elif ta_proposed_tension >= 4 %}#c07800{% else %}#2a7a2a{% endif %};">
      {{ ta_proposed_tension }}
    </span>
    / 9
  </p>
  <p>
    <strong>Votes:</strong>
    {{ ta_yes_count }} escalate (+1) &middot;
    {{ ta_suggest_count }} hold steady (0) &middot;
    {{ ta_no_count }} ease (-1)
    &nbsp;({{ total_players }} player{{ "s" if total_players != 1 else "" }} total —
    plurality wins; tie or no votes → AI suggestion applies)
  </p>
  {% if tension_adj_proposal.votes %}
  <ul>
    {% for v in tension_adj_proposal.votes %}
    <li>
      <strong>{{ v.voter.display_name if v.voter else "Unknown" }}:</strong>
      {% if v.choice.value == "yes" %}+1 (Escalate)
      {% elif v.choice.value == "no" %}-1 (Ease tension)
      {% else %}0 (Hold steady){% endif %}
    </li>
    {% endfor %}
  </ul>
  {% endif %}
  {% if not ta_my_vote %}
  <form method="post" action="/games/{{ game.id }}/proposals/{{ tension_adj_proposal.id }}/vote"
        style="margin-top:0.75rem;">
    <fieldset>
      <legend><strong>Your vote on tension for the next scene:</strong></legend>
      <label style="display:block; margin:0.4rem 0;">
        <input type="radio" name="choice" value="yes" required> +1 Escalate
      </label>
      <label style="display:block; margin:0.4rem 0;">
        <input type="radio" name="choice" value="suggest_modification"> 0 Hold steady
      </label>
      <label style="display:block; margin:0.4rem 0;">
        <input type="radio" name="choice" value="no"> -1 Ease tension
      </label>
      <button type="submit" style="margin-top:0.5rem;">Submit vote</button>
    </fieldset>
  </form>
  {% else %}
  <p>Your vote: <strong>
    {% if ta_my_vote.choice.value == "yes" %}+1 (Escalate)
    {% elif ta_my_vote.choice.value == "no" %}-1 (Ease tension)
    {% else %}0 (Hold steady){% endif %}
  </strong></p>
  {% endif %}
</section>
{% endif %}

<section style="margin-top:1.5rem; border-top:1px solid #ddd; padding-top:1rem;">
  <h2>Submit a Beat</h2>
  {% if scene.status.value == "active" %}
  <form method="post" action="/games/{{ game.id }}/acts/{{ act.id }}/scenes/{{ scene.id }}/beats">
    <div id="events-container"></div>
    <div style="margin:0.5rem 0; display:flex; gap:0.4rem; flex-wrap:wrap;">
      <button type="button" onclick="beatComposer.addEvent('narrative')">+ Narrative</button>
      <button type="button" onclick="beatComposer.addEvent('ooc')">+ OOC</button>
      <button type="button" onclick="beatComposer.addEvent('roll')">+ Roll</button>
      <a href="/games/{{ game.id }}/acts/{{ act.id }}/scenes/{{ scene.id }}/oracle"
         style="display:inline-block; padding:0.3rem 0.6rem; border:1px solid #ccc; border-radius:3px; background:#f7f7f0; text-decoration:none; color:#333; font-size:0.9rem;">+ Oracle</a>
      <a href="/games/{{ game.id }}/acts/{{ act.id }}/scenes/{{ scene.id }}/fortune-roll"
         style="display:inline-block; padding:0.3rem 0.6rem; border:1px solid #ccc; border-radius:3px; background:#f0f4fa; text-decoration:none; color:#333; font-size:0.9rem;">+ Fortune Roll</a>
    </div>
    <div style="margin:0.75rem 0; padding:0.6rem 0.75rem; background:#f7f7f0; border:1px solid #ddd; border-radius:4px; max-width:36rem;">
      <div style="font-size:0.85rem; color:#555; margin-bottom:0.4rem;">
        <strong>Beat significance</strong>
        <span style="font-weight:normal; color:#888;">&mdash; AI suggests: <em>Minor</em></span>
      </div>
      <label style="margin-right:1rem;">
        <input type="radio" name="beat_significance" value="minor" checked> Minor
        <span style="font-size:0.8rem; color:#888;">(canon immediately)</span>
      </label>
      <label>
        <input type="radio" name="beat_significance" value="major"> Major
        <span style="font-size:0.8rem; color:#888;">(requires group vote)</span>
      </label>
    </div>
    {% if spotlightable_chars %}
    <div style="margin:0.75rem 0; padding:0.6rem 0.75rem; background:#f7f7f0; border:1px solid #ddd; border-radius:4px; max-width:36rem;">
      <div style="font-size:0.85rem; color:#555; margin-bottom:0.4rem;">
        <strong>Spotlight (optional)</strong>
        <span style="font-weight:normal; color:#888;">&mdash; waiting for a response from&hellip;</span>
      </div>
      <select name="waiting_for_character_id" style="font-size:0.9rem; padding:0.2rem 0.4rem;">
        <option value="">&#x2014; no spotlight &#x2014;</option>
        {% for char in spotlightable_chars %}
        <option value="{{ char.id }}">{{ char.name }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    <div id="consistency-results" style="display:none; margin:0.75rem 0; padding:0.75rem; background:#fff8e6; border:1px solid #e0b84d; border-radius:4px; max-width:36rem;"></div>
    <div style="margin-top:0.25rem; display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
      <button type="button" id="check-submit-btn" onclick="beatComposer.checkAndSubmit(event)">Submit Beat</button>
      <button type="button" id="submit-anyway-btn" onclick="beatComposer.submitAnyway()" style="display:none;">Submit Anyway</button>
      <button type="button" id="revise-btn" onclick="beatComposer.dismissCheck()" style="display:none;">Revise</button>
    </div>
  </form>
  <script>
  const beatComposer = {
    _labels: { narrative: 'Narrative', ooc: 'OOC (out of character)', roll: 'Roll' },
    _placeholders: {
      narrative: 'Describe what happens\u2026',
      ooc: 'Out-of-character comment or question\u2026',
    },

    addEvent(type) {
      const container = document.getElementById('events-container');
      const row = document.createElement('div');
      row.className = 'event-row';
      row.style.cssText = 'border:1px solid #ddd; padding:0.75rem; margin-bottom:0.5rem; border-radius:4px;';

      const isRoll = type === 'roll';
      row.innerHTML = `
        <div style="font-size:0.85rem; font-weight:bold; color:#555; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.04em;">
          ${this._labels[type]}
          <button type="button" class="remove-btn"
            onclick="beatComposer.removeEvent(this)"
            style="float:right; font-size:0.8rem; font-weight:normal; display:none;">Remove</button>
        </div>
        <input type="hidden" name="event_type" value="${type}">
        <div class="field-content" style="${isRoll ? 'display:none;' : ''}">
          <textarea name="event_content" rows="3"
            style="width:100%; max-width:36rem;"
            placeholder="${this._placeholders[type] || ''}"></textarea>
        </div>
        <div class="field-roll" style="${isRoll ? '' : 'display:none;'}">
          <div style="margin-bottom:0.3rem;">
            <label style="font-size:0.9rem;">Notation:&nbsp;
              <input name="event_notation" type="text" placeholder="e.g. 2d6+3" style="width:9rem;">
            </label>
          </div>
          <div>
            <label style="font-size:0.9rem;">Reason:&nbsp;
              <input name="event_reason" type="text" placeholder="Optional reason" style="width:20rem;">
            </label>
          </div>
        </div>`;

      container.appendChild(row);
      this._updateRemoveButtons();
    },

    removeEvent(btn) {
      btn.closest('.event-row').remove();
      this._updateRemoveButtons();
    },

    _updateRemoveButtons() {
      const rows = document.querySelectorAll('.event-row');
      rows.forEach(row => {
        row.querySelector('.remove-btn').style.display = rows.length > 1 ? '' : 'none';
      });
    },

    async checkAndSubmit(e) {
      const form = e.target.closest('form');
      const checkBtn = document.getElementById('check-submit-btn');
      const resultsDiv = document.getElementById('consistency-results');

      checkBtn.disabled = true;
      checkBtn.textContent = 'Checking\u2026';
      resultsDiv.style.display = 'none';

      try {
        const checkUrl = form.action + '/check';
        const resp = await fetch(checkUrl, { method: 'POST', body: new FormData(form) });
        if (!resp.ok) throw new Error('check failed');
        const data = await resp.json();

        if (!data.flags || data.flags.length === 0) {
          form.submit();
          return;
        }

        // Show flags
        let html = '<strong style="font-size:0.9rem;">Consistency check flagged the following:</strong><ul style="margin:0.4rem 0 0.5rem 1.2rem; padding:0;">';
        data.flags.forEach(f => { html += `<li style="font-size:0.9rem; margin-bottom:0.2rem;">${f}</li>`; });
        html += '</ul><p style="font-size:0.85rem; color:#666; margin:0;">These are advisory only &mdash; you can revise your beat or submit anyway.</p>';
        resultsDiv.innerHTML = html;
        resultsDiv.style.display = '';

        checkBtn.style.display = 'none';
        document.getElementById('submit-anyway-btn').style.display = '';
        document.getElementById('revise-btn').style.display = '';
      } catch (_) {
        // AI check failed — fall through to normal submission
        form.submit();
      }
    },

    submitAnyway() {
      const form = document.getElementById('check-submit-btn').closest('form');
      form.submit();
    },

    dismissCheck() {
      document.getElementById('consistency-results').style.display = 'none';
      document.getElementById('submit-anyway-btn').style.display = 'none';
      document.getElementById('revise-btn').style.display = 'none';
      const checkBtn = document.getElementById('check-submit-btn');
      checkBtn.style.display = '';
      checkBtn.disabled = false;
      checkBtn.textContent = 'Submit Beat';
    },
  };

  beatComposer.addEvent('narrative');
  </script>
  {% else %}
  <p style="color:#888; font-style:italic;">Beat submission is only available for active scenes.</p>
  {% endif %}
</section>

<p style="margin-top:1.5rem;"><a href="/games/{{ game.id }}/acts/{{ act.id }}/scenes">&larr; Back to Scenes</a></p>
{% endblock %}
