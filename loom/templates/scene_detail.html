{% extends "base.html" %}

{% block title %}Scene {{ scene.order }} — {{ act.title if act.title else "Act " ~ act.order }} — {{ game.name }} — Loom{% endblock %}

{% block content %}
<h1>{{ game.name }} &mdash; {{ act.title if act.title else "Act " ~ act.order }} &mdash; Scene {{ scene.order }}</h1>

<nav>
    <strong>Nav:</strong>
    <a href="/games/{{ game.id }}">Dashboard</a> |
    <a href="/games/{{ game.id }}/acts">Acts</a> |
    <a href="/games/{{ game.id }}/acts/{{ act.id }}/scenes">Scenes</a> |
    <a href="/games/{{ game.id }}/characters">Characters</a> |
    <a href="/games/{{ game.id }}/safety-tools">Safety Tools</a> |
    <a href="/games/{{ game.id }}/world-document">World Doc</a>
</nav>

<section style="margin-top:1.5rem; padding:1rem; border:1px solid #ccc; border-radius:4px; background:#fafafa;">
  <h2 style="margin-top:0;">Scene {{ scene.order }}: {{ scene.guiding_question }}</h2>
  {% if scene.location %}
  <p><strong>Location:</strong> {{ scene.location }}</p>
  {% endif %}
  <p>
    <strong>Tension:</strong>
    <span style="font-size:1.2rem; font-weight:bold; color:{% if scene.tension >= 7 %}#c04000{% elif scene.tension >= 4 %}#c07800{% else %}#2a7a2a{% endif %};">
      {{ scene.tension }}
    </span>
    / 9
    &nbsp;&mdash;&nbsp;
    <strong>Status:</strong> {{ scene.status.value | capitalize }}
  </p>
  {% if scene.characters_present %}
  <p>
    <strong>Characters present:</strong>
    {% for char in scene.characters_present %}{{ char.name }}{% if not loop.last %}, {% endif %}{% endfor %}
  </p>
  {% endif %}
</section>

<section style="margin-top:1.5rem;">
  <h2>Beat Timeline</h2>

  <nav style="margin-bottom:0.75rem;">
    <strong>Filter:</strong>
    <a href="?filter=all"{% if filter == "all" %} style="font-weight:bold;" aria-current="page"{% endif %}>All</a> |
    <a href="?filter=ic"{% if filter == "ic" %} style="font-weight:bold;" aria-current="page"{% endif %}>IC Only</a> |
    <a href="?filter=ooc"{% if filter == "ooc" %} style="font-weight:bold;" aria-current="page"{% endif %}>OOC Only</a>
  </nav>

  <div
    id="beat-timeline"
    hx-get="/games/{{ game.id }}/acts/{{ act.id }}/scenes/{{ scene.id }}/beats?filter={{ filter }}"
    hx-trigger="every 5s"
    hx-target="#beat-timeline"
    hx-swap="innerHTML"
  >
    {% include "_beats_partial.html" %}
  </div>
</section>

<section style="margin-top:1.5rem; border-top:1px solid #ddd; padding-top:1rem;">
  <h2>Submit a Beat</h2>
  {% if scene.status.value == "active" %}
  <form method="post" action="/games/{{ game.id }}/acts/{{ act.id }}/scenes/{{ scene.id }}/beats">
    <div id="events-container"></div>
    <div style="margin:0.5rem 0; display:flex; gap:0.4rem; flex-wrap:wrap;">
      <button type="button" onclick="beatComposer.addEvent('narrative')">+ Narrative</button>
      <button type="button" onclick="beatComposer.addEvent('ooc')">+ OOC</button>
      <button type="button" onclick="beatComposer.addEvent('roll')">+ Roll</button>
    </div>
    <button type="submit" style="margin-top:0.25rem;">Submit Beat</button>
  </form>
  <script>
  const beatComposer = {
    _labels: { narrative: 'Narrative', ooc: 'OOC (out of character)', roll: 'Roll' },
    _placeholders: {
      narrative: 'Describe what happens\u2026',
      ooc: 'Out-of-character comment or question\u2026',
    },

    addEvent(type) {
      const container = document.getElementById('events-container');
      const row = document.createElement('div');
      row.className = 'event-row';
      row.style.cssText = 'border:1px solid #ddd; padding:0.75rem; margin-bottom:0.5rem; border-radius:4px;';

      const isRoll = type === 'roll';
      row.innerHTML = `
        <div style="font-size:0.85rem; font-weight:bold; color:#555; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.04em;">
          ${this._labels[type]}
          <button type="button" class="remove-btn"
            onclick="beatComposer.removeEvent(this)"
            style="float:right; font-size:0.8rem; font-weight:normal; display:none;">Remove</button>
        </div>
        <input type="hidden" name="event_type" value="${type}">
        <div class="field-content" style="${isRoll ? 'display:none;' : ''}">
          <textarea name="event_content" rows="3"
            style="width:100%; max-width:36rem;"
            placeholder="${this._placeholders[type] || ''}"></textarea>
        </div>
        <div class="field-roll" style="${isRoll ? '' : 'display:none;'}">
          <div style="margin-bottom:0.3rem;">
            <label style="font-size:0.9rem;">Notation:&nbsp;
              <input name="event_notation" type="text" placeholder="e.g. 2d6+3" style="width:9rem;">
            </label>
          </div>
          <div>
            <label style="font-size:0.9rem;">Reason:&nbsp;
              <input name="event_reason" type="text" placeholder="Optional reason" style="width:20rem;">
            </label>
          </div>
        </div>`;

      container.appendChild(row);
      this._updateRemoveButtons();
    },

    removeEvent(btn) {
      btn.closest('.event-row').remove();
      this._updateRemoveButtons();
    },

    _updateRemoveButtons() {
      const rows = document.querySelectorAll('.event-row');
      rows.forEach(row => {
        row.querySelector('.remove-btn').style.display = rows.length > 1 ? '' : 'none';
      });
    },
  };

  beatComposer.addEvent('narrative');
  </script>
  {% else %}
  <p style="color:#888; font-style:italic;">Beat submission is only available for active scenes.</p>
  {% endif %}
</section>

<p style="margin-top:1.5rem;"><a href="/games/{{ game.id }}/acts/{{ act.id }}/scenes">&larr; Back to Scenes</a></p>
{% endblock %}
