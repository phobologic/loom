{% extends "base.html" %}

{% block title %}{{ game.name }} — Acts — Loom{% endblock %}

{% block content %}
<h1>{{ game.name }} — Acts</h1>
<p><strong>Status:</strong> {{ game.status.value | capitalize }}</p>

<nav>
    <strong>Nav:</strong>
    <a href="/games/{{ game.id }}/acts">Acts</a> |
    {% if game.status.value != "setup" %}<a href="/games/{{ game.id }}/characters">Characters</a> | {% endif %}
    <a href="/games/{{ game.id }}/settings">Settings</a> |
    {% if game.status.value == "setup" %}<a href="/games/{{ game.id }}/session0">Session 0</a> | {% endif %}
    <a href="/games/{{ game.id }}/safety-tools">Safety Tools</a> |
    <a href="/games/{{ game.id }}/world-document">World Doc</a>
</nav>

<section style="margin-top:1.5rem;">
  <h2>Acts</h2>
  {% if acts %}
  <ol>
    {% for act in acts %}
    <li>
      <strong>{{ act.title if act.title else "Act " ~ loop.index }}</strong>
      <em>({{ act.status.value | capitalize }})</em>
      — {{ act.guiding_question }}
      {% if act.status.value in ("active", "complete") %}
      — <a href="/games/{{ game.id }}/acts/{{ act.id }}/scenes">Scenes</a>
      {% endif %}
    </li>
    {% endfor %}
  </ol>
  {% else %}
  <p>No acts yet. Propose the first act to begin play.</p>
  {% endif %}
</section>

{% if open_proposal %}
<section style="margin-top:1.5rem; border-top:1px solid #ddd; padding-top:1rem;">
  <h2>Pending Act Proposal</h2>
  <p>
    <strong>{{ open_proposal.act.title if open_proposal.act and open_proposal.act.title else "Untitled Act" }}</strong>
    {% if open_proposal.act %} — {{ open_proposal.act.guiding_question }}{% endif %}
  </p>
  <p>
    <strong>Proposed by:</strong> {{ open_proposal.proposed_by.display_name if open_proposal.proposed_by else "Unknown" }}
    &mdash; <strong>Status:</strong> {{ open_proposal.status.value | capitalize }}
  </p>
  <p>
    <strong>Votes:</strong> {{ yes_count }} yes &middot; {{ no_count }} no &middot; {{ suggest_count }} suggestion(s)
    &nbsp;({{ total_players }} player{{ "s" if total_players != 1 else "" }} total,
    threshold: more than {{ threshold | int if threshold == (threshold | int) else threshold }})
  </p>

  {% if open_proposal.votes %}
  <ul>
    {% for v in open_proposal.votes %}
    <li>
      <strong>{{ v.voter.display_name if v.voter else "Anonymous" }}:</strong>
      {{ v.choice.value | replace("_", " ") | capitalize }}
      {% if v.suggestion %}
      <br><em style="color:#555;">Suggestion: {{ v.suggestion }}</em>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
  {% endif %}

  {% if not my_vote %}
  <form method="post" action="/games/{{ game.id }}/proposals/{{ open_proposal.id }}/vote" style="margin-top:1rem;">
    <fieldset>
      <legend><strong>Cast your vote</strong></legend>
      <label style="display:block; margin:0.4rem 0;">
        <input type="radio" name="choice" value="yes" required> Yes, approve
      </label>
      <label style="display:block; margin:0.4rem 0;">
        <input type="radio" name="choice" value="no"> No, reject
      </label>
      <label style="display:block; margin:0.4rem 0;">
        <input type="radio" name="choice" value="suggest_modification"> Suggest modification
      </label>
      <div style="margin-top:0.5rem;">
        <label for="suggestion">Suggestion (optional):</label><br>
        <textarea id="suggestion" name="suggestion" rows="3" style="width:100%; box-sizing:border-box;"></textarea>
      </div>
      <button type="submit" style="margin-top:0.5rem;">Submit vote</button>
    </fieldset>
  </form>
  {% else %}
  <p>Your vote: <strong>{{ my_vote.choice.value | replace("_", " ") | capitalize }}</strong>
  {% if my_vote.suggestion %} &mdash; <em>{{ my_vote.suggestion }}</em>{% endif %}</p>
  {% endif %}
</section>
{% endif %}

{% if game.status.value == "active" and not open_proposal %}
<section style="margin-top:1.5rem; border-top:1px solid #ddd; padding-top:1rem;">
  <h2>Propose a New Act</h2>
  <form method="post" action="/games/{{ game.id }}/acts">
    <div>
      <label for="title">Title (optional):</label><br>
      <input type="text" id="title" name="title" style="width:100%; box-sizing:border-box;">
    </div>
    <div style="margin-top:0.5rem;">
      <label for="guiding_question">Guiding Question (required):</label><br>
      <textarea id="guiding_question" name="guiding_question" rows="3" required
        style="width:100%; box-sizing:border-box;"
        placeholder="e.g. Who is behind the disappearances in the Rusted Quarter?"></textarea>
    </div>
    <button type="submit" style="margin-top:0.5rem;">Propose Act</button>
  </form>
</section>
{% endif %}

<p style="margin-top:1.5rem;"><a href="/games/{{ game.id }}">&larr; Game Dashboard</a></p>
{% endblock %}
