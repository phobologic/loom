{% extends "base.html" %}

{% block title %}World Entries — {{ game.name }} — Loom{% endblock %}

{% block content %}
<h1>World Entries — {{ game.name }}</h1>
<p><strong>Status:</strong> {{ game.status.value | capitalize }}</p>

<nav>
    <strong>Nav:</strong>
    <a href="/games/{{ game.id }}">Dashboard</a> |
    <a href="/games/{{ game.id }}/characters">Characters</a> |
    <a href="/games/{{ game.id }}/npcs">NPCs</a> |
    <a href="/games/{{ game.id }}/world-entries">World Entries</a> |
    <a href="/games/{{ game.id }}/relationships">Relationships</a> |
    <a href="/games/{{ game.id }}/safety-tools">Safety Tools</a> |
    <a href="/games/{{ game.id }}/world-document">World Doc</a> |
    <a href="/games/{{ game.id }}/settings">Settings</a>
</nav>

{% if editing %}
<section style="margin-top:1.5rem; padding:0.75rem; border:1px solid #999;">
  <h2>Edit Entry: {{ editing.name }}</h2>
  <form method="post" action="/games/{{ game.id }}/world-entries/{{ editing.id }}/edit">
    <div style="margin-bottom:0.5rem;">
      <label for="edit-type"><strong>Type</strong> (required)</label><br>
      <select id="edit-type" name="entry_type" required style="margin-top:0.2rem;">
        {% for t in entry_types %}
        <option value="{{ t.value }}" {% if editing.entry_type == t %}selected{% endif %}>{{ t.value | capitalize }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="margin-bottom:0.5rem;">
      <label for="edit-name"><strong>Name</strong> (required)</label><br>
      <input id="edit-name" type="text" name="name" value="{{ editing.name }}" maxlength="150" required style="width:100%; max-width:400px;">
    </div>
    <div style="margin-bottom:0.5rem;">
      <label for="edit-description"><strong>Description</strong></label><br>
      <textarea id="edit-description" name="description" rows="4" style="width:100%; max-width:600px;">{{ editing.description or "" }}</textarea>
    </div>
    <button type="submit">Save Changes</button>
    <a href="/games/{{ game.id }}/world-entries" style="margin-left:0.75rem;">Cancel</a>
  </form>
</section>
{% endif %}

{% if pending_suggestions %}
<section style="margin-top:1.5rem; padding:0.75rem; border:1px solid #c8a200; background:#fffbe6;">
  <h2>AI Suggestions ({{ pending_suggestions | length }})</h2>
  <p style="margin:0 0 0.75rem; color:#666; font-size:0.9em;">
    The AI spotted these world elements in recent beats. Any player can accept or dismiss.
  </p>
  <ul style="list-style:none; padding:0;">
    {% for sug in pending_suggestions %}
    <li style="margin-bottom:1rem; padding:0.75rem; border:1px solid #e6c800; background:#fff;">
      <strong>{{ sug.suggested_name }}</strong>
      <span style="font-size:0.82rem; color:#666; margin-left:0.5rem;">[{{ sug.suggested_type.value | capitalize }}]</span>
      {% if sug.suggested_description %}
        <p style="margin:0.4rem 0 0.2rem;">{{ sug.suggested_description }}</p>
      {% endif %}
      <p style="margin:0.2rem 0 0.5rem; font-size:0.85rem; color:#888;"><em>Why: {{ sug.reason }}</em></p>
      {% if game.status.value in ("active", "paused") %}
      <form method="post" action="/games/{{ game.id }}/world-entry-suggestions/{{ sug.id }}/accept" style="display:inline;">
        <button type="submit">Accept</button>
      </form>
      <form method="post" action="/games/{{ game.id }}/world-entry-suggestions/{{ sug.id }}/dismiss" style="display:inline; margin-left:0.5rem;">
        <button type="submit">Dismiss</button>
      </form>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
</section>
{% endif %}

<section style="margin-top:1.5rem;">
  <h2>Entries ({{ entries | length }})</h2>
  {% if entries %}
  <ul style="list-style:none; padding:0;">
    {% for entry in entries %}
    <li style="margin-bottom:1rem; padding:0.75rem; border:1px solid #ddd;">
      <strong>{{ entry.name }}</strong>
      <span style="font-size:0.82rem; color:#666; margin-left:0.5rem;">[{{ entry.entry_type.value | capitalize }}]</span>
      {% if entry.description %}
        <p style="margin:0.4rem 0 0;">{{ entry.description }}</p>
      {% endif %}
      {% if entry_relationships and entry_relationships[entry.id] %}
        <div style="margin-top:0.4rem; font-size:0.9em; color:#444;">
          <strong>Relationships:</strong>
          {% for item in entry_relationships[entry.id] %}
            {% if item.direction == "a" %}
              <span style="margin-right:0.5rem;">→ <em>{{ item.label }}</em> {{ item.other_name }}</span>
            {% else %}
              <span style="margin-right:0.5rem;">← <em>{{ item.label }}</em> {{ item.other_name }}</span>
            {% endif %}
          {% endfor %}
          <a href="/games/{{ game.id }}/relationships" style="font-size:0.9em; margin-left:0.25rem;">(manage)</a>
        </div>
      {% endif %}
      {% if game.status.value != "archived" %}
      <a href="/games/{{ game.id }}/world-entries/{{ entry.id }}/edit" style="font-size:0.9em;">Edit</a>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No world entries yet.</p>
  {% endif %}
</section>

{% if not editing and game.status.value in ("active", "paused") %}
<section style="margin-top:1.5rem; padding:0.75rem; border:1px solid #ccc;">
  <h2>Add Entry</h2>
  {% if game.status.value == "paused" %}
  <p style="color:#888;"><em>The game is paused. Entry creation will resume when the game is active.</em></p>
  {% else %}
  <form method="post" action="/games/{{ game.id }}/world-entries">
    <div style="margin-bottom:0.5rem;">
      <label for="entry_type"><strong>Type</strong> (required)</label><br>
      <select id="entry_type" name="entry_type" required style="margin-top:0.2rem;">
        {% for t in entry_types %}
        <option value="{{ t.value }}">{{ t.value | capitalize }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="margin-bottom:0.5rem;">
      <label for="name"><strong>Name</strong> (required)</label><br>
      <input id="name" type="text" name="name" maxlength="150" required style="width:100%; max-width:400px;">
    </div>
    <div style="margin-bottom:0.5rem;">
      <label for="description"><strong>Description</strong></label><br>
      <textarea id="description" name="description" rows="4" style="width:100%; max-width:600px;"></textarea>
    </div>
    <button type="submit">Add Entry</button>
  </form>
  {% endif %}
</section>
{% endif %}

<p style="margin-top:1rem;"><a href="/games/{{ game.id }}">&larr; Dashboard</a></p>
{% endblock %}
