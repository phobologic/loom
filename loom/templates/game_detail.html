{% extends "base.html" %}

{% block title %}{{ game.name }} — Loom{% endblock %}

{% block content %}
<h1>{{ game.name }}</h1>
<p><strong>Status:</strong> {{ game.status.value | capitalize }}</p>

<nav>
    <strong>Nav:</strong>
    <a href="/games/{{ game.id }}/acts">Acts</a> |
    {% if game.status.value != "setup" %}<a href="/games/{{ game.id }}/characters">Characters</a> | {% endif %}
    <a href="/games/{{ game.id }}/settings">Settings</a> |
    {% if game.status.value == "setup" %}<a href="/games/{{ game.id }}/session0">Session 0</a> | {% endif %}
    <a href="/games/{{ game.id }}/safety-tools">Safety Tools</a> |
    <a href="/games/{{ game.id }}/world-document">World Doc</a>
</nav>

{% if game.status.value == "setup" %}
<section style="margin-top:1rem; padding:0.75rem; border:1px solid #ccc;">
  <h2>Session 0</h2>
  <p>Establish the world collaboratively before play begins.</p>
  <a href="/games/{{ game.id }}/session0">
    {% if current_member.role.value == "organizer" %}Run Session 0 Wizard{% else %}Contribute to Session 0{% endif %}
  </a>
</section>
{% endif %}

<h2>Members ({{ members | length }}/{{ max_players }})</h2>
<ul>
    {% for m in members %}
    <li>
        {{ m.user.display_name }}
        {% if m.role.value == "organizer" %}<em>(organizer)</em>{% endif %}
    </li>
    {% endfor %}
</ul>

{% if current_member.role.value == "organizer" %}
<h2>Invite Link</h2>
{% if invite_url %}
<p>Share this link with players:</p>
<code>{{ invite_url }}</code>
<div style="margin-top:0.5rem;">
    <form method="post" action="/games/{{ game.id }}/invite/regenerate" style="display:inline;">
        <button type="submit">Regenerate</button>
    </form>
    <form method="post" action="/games/{{ game.id }}/invite/revoke" style="display:inline; margin-left:0.5rem;">
        <button type="submit">Revoke</button>
    </form>
</div>
{% else %}
<p>Invite link has been revoked.</p>
<form method="post" action="/games/{{ game.id }}/invite/regenerate">
    <button type="submit">Generate new invite link</button>
</form>
{% endif %}
{% endif %}

{% if current_member.role.value == "organizer" %}
<section style="margin-top:1.5rem; border-top:1px solid #ddd; padding-top:1rem;">
  <h2>Game Management</h2>
  {% if game.status.value == "active" %}
  <form method="post" action="/games/{{ game.id }}/pause" style="display:inline;">
    <button type="submit">Pause Game</button>
  </form>
  {% endif %}
  {% if game.status.value == "paused" %}
  <form method="post" action="/games/{{ game.id }}/resume" style="display:inline;">
    <button type="submit">Resume Game</button>
  </form>
  {% endif %}
  {% if game.status.value != "archived" %}
  <form method="post" action="/games/{{ game.id }}/archive" style="display:inline; margin-left:0.5rem;">
    <button type="submit" onclick="return confirm('Archive this game? It will become read-only.')">Archive Game</button>
  </form>
  {% endif %}
</section>
{% endif %}

<section style="margin-top:1.5rem; border-top:1px solid #ddd; padding-top:1rem;">
  <h2>Your Preferences for This Game</h2>
  <form method="post" action="/games/{{ game.id }}/prose-preference">
    <label for="prose_mode_override" style="font-size:0.9rem;">Prose suggestions:</label>
    <select name="prose_mode_override" id="prose_mode_override" style="margin-left:0.4rem; font-size:0.9rem;">
      <option value="" {% if not current_member.prose_mode_override %}selected{% endif %}>Use account default</option>
      <option value="always" {% if current_member.prose_mode_override == "always" %}selected{% endif %}>Always</option>
      <option value="never" {% if current_member.prose_mode_override == "never" %}selected{% endif %}>Never</option>
      <option value="threshold" {% if current_member.prose_mode_override == "threshold" %}selected{% endif %}>Threshold only</option>
    </select>
    <button type="submit" style="margin-left:0.5rem; font-size:0.85rem;">Save</button>
  </form>

  <form method="post" action="/games/{{ game.id }}/email-preference" style="margin-top:0.75rem;">
    <label for="email_pref_override" style="font-size:0.9rem;">Email notifications:</label>
    <select name="email_pref_override" id="email_pref_override" style="margin-left:0.4rem; font-size:0.9rem;">
      <option value="" {% if not current_member.email_pref_override %}selected{% endif %}>Use account default</option>
      <option value="immediate" {% if current_member.email_pref_override == "immediate" %}selected{% endif %}>Immediate</option>
      <option value="digest" {% if current_member.email_pref_override == "digest" %}selected{% endif %}>Digest</option>
      <option value="off" {% if current_member.email_pref_override == "off" %}selected{% endif %}>Off</option>
    </select>
    <button type="submit" style="margin-left:0.5rem; font-size:0.85rem;">Save</button>
  </form>
</section>

<section style="margin-top:1.5rem; border-top:1px solid #ddd; padding-top:1rem;">
  <h2>Acts</h2>
  {% if acts %}
  <ol>
    {% for act in acts %}
    <li>
      <strong>{{ act.title if act.title else "Act " ~ loop.index }}</strong>
      <em>({{ act.status.value | capitalize }})</em>
      {% if act.guiding_question %} — {{ act.guiding_question }}{% endif %}
      {% if act.status.value == "active" and act.scenes %}
      <ul style="margin-top:0.5rem;">
        {% for scene in act.scenes %}
        <li>
          Scene {{ loop.index }}: {{ scene.guiding_question }}
          {% if scene.location %} — <em>{{ scene.location }}</em>{% endif %}
          [{{ scene.status.value | capitalize }}{% if scene.status.value == "active" %}, tension {{ scene.tension }}{% endif %}]
        </li>
        {% endfor %}
      </ul>
      {% endif %}
    </li>
    {% endfor %}
  </ol>
  {% else %}
  <p>No acts yet. Acts will appear here once play begins.</p>
  {% endif %}
</section>

<p style="margin-top:1rem;"><a href="/games">&larr; My Games</a></p>
{% endblock %}
