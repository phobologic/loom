{% extends "base.html" %}

{% block title %}{{ game.name }} — Session 0 — Loom{% endblock %}

{% block content %}
<h1>{{ game.name }} — Session 0</h1>

{% if game.pitch %}
<section>
  <strong>Starting pitch:</strong>
  <p>{{ game.pitch }}</p>
</section>
{% endif %}

<div style="display:flex; gap:2rem; align-items:flex-start; margin-top:1rem;">

  <!-- Sidebar: prompt list -->
  <aside style="min-width:220px; max-width:260px;">
    <h3>Prompts</h3>
    <ol style="padding-left:1.2rem;">
      {% for p in all_prompts %}
      <li style="margin-bottom:0.4rem; {% if p.id == prompt.id %}font-weight:bold;{% endif %}">
        <a href="/games/{{ game.id }}/session0/{{ p.id }}">{{ p.question | truncate(45) }}</a>
        <small>[{{ p.status.value }}]</small>

        {% if current_member.role.value == "organizer" and p.status.value == "pending" %}
        <form method="post" action="/games/{{ game.id }}/session0/prompts/{{ p.id }}/move" style="display:inline;">
          <input type="hidden" name="direction" value="up">
          <button type="submit" style="padding:0 4px; font-size:0.75rem;"
            {% if loop.first %}disabled{% endif %}>▲</button>
        </form>
        <form method="post" action="/games/{{ game.id }}/session0/prompts/{{ p.id }}/move" style="display:inline;">
          <input type="hidden" name="direction" value="down">
          <button type="submit" style="padding:0 4px; font-size:0.75rem;"
            {% if loop.last %}disabled{% endif %}>▼</button>
        </form>
        {% endif %}
      </li>
      {% endfor %}
    </ol>

    {% if current_member.role.value == "organizer" %}
    <form method="post" action="/games/{{ game.id }}/session0/prompts/add" style="margin-top:1rem;">
      <label for="custom_question"><strong>Add custom prompt:</strong></label><br>
      <input type="text" id="custom_question" name="question" placeholder="Your question..." style="width:100%; box-sizing:border-box;" required>
      <button type="submit" style="margin-top:0.3rem;">Add</button>
    </form>
    {% endif %}
  </aside>

  <!-- Main panel -->
  <main style="flex:1;">
    <h2>{{ prompt.question }}</h2>
    <p><strong>Status:</strong> {{ prompt.status.value | capitalize }}</p>

    {% if prompt.is_word_seeds %}

    <!-- Word Seeds UI — replaces the normal contributions/synthesis flow -->
    <p>Select which themed word tables are active for Oracle invocations. Any member can toggle tables or add custom words.</p>

    {% set builtin_tables = word_seed_tables | selectattr("is_builtin") | list %}
    {% set custom_tables = word_seed_tables | rejectattr("is_builtin") | list %}

    <section>
      <h3>Themed Tables</h3>
      {% for table in builtin_tables %}
      <div style="margin-bottom:0.6rem; padding:0.5rem 0.75rem; border:1px solid #ddd; border-radius:4px; background:{% if table.is_active %}#f0fff0{% else %}#fafafa{% endif %}; display:flex; align-items:center; gap:1rem;">
        <strong style="text-transform:capitalize; min-width:70px;">{{ table.category }}</strong>
        <span style="color:{% if table.is_active %}#2a7a2a{% else %}#999{% endif %}; font-size:0.85rem;">{{ "Active" if table.is_active else "Inactive" }}</span>
        {% set action_count = table.entries | selectattr("word_type.value", "equalto", "action") | list | length %}
        {% set desc_count = table.entries | selectattr("word_type.value", "equalto", "descriptor") | list | length %}
        <small style="color:#888;">{{ action_count }} action, {{ desc_count }} descriptor</small>
        <form method="post" action="/games/{{ game.id }}/word-seeds/{{ table.id }}/toggle" style="margin-left:auto;">
          <button type="submit" style="font-size:0.85rem;">{{ "Deactivate" if table.is_active else "Activate" }}</button>
        </form>
      </div>
      {% endfor %}
    </section>

    {% set custom_entries = namespace(items=[]) %}
    {% for t in custom_tables %}
      {% for e in t.entries %}
        {% set custom_entries.items = custom_entries.items + [e] %}
      {% endfor %}
    {% endfor %}

    <section style="margin-top:1rem;">
      <h3>Custom Words</h3>
      {% set custom_actions = custom_entries.items | selectattr("word_type.value", "equalto", "action") | list %}
      {% set custom_descs = custom_entries.items | selectattr("word_type.value", "equalto", "descriptor") | list %}
      {% if custom_actions or custom_descs %}
      <ul>
        {% for e in custom_actions %}
        <li>
          <em>action:</em> {{ e.word }}
          {% if current_member.role.value == "organizer" %}
          <form method="post" action="/games/{{ game.id }}/word-seeds/entries/{{ e.id }}/delete" style="display:inline; margin-left:0.4rem;">
            <button type="submit" style="font-size:0.75rem;">Remove</button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
        {% for e in custom_descs %}
        <li>
          <em>descriptor:</em> {{ e.word }}
          {% if current_member.role.value == "organizer" %}
          <form method="post" action="/games/{{ game.id }}/word-seeds/entries/{{ e.id }}/delete" style="display:inline; margin-left:0.4rem;">
            <button type="submit" style="font-size:0.75rem;">Remove</button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p><em>No custom words added yet.</em></p>
      {% endif %}
    </section>

    {% if prompt.status.value == "active" %}
    <section style="margin-top:1rem;">
      <h3>Add a custom word</h3>
      <form method="post" action="/games/{{ game.id }}/word-seeds/entries/add">
        <select name="word_type" required style="margin-right:0.5rem;">
          <option value="action">Action word</option>
          <option value="descriptor">Descriptor word</option>
        </select>
        <input type="text" name="word" placeholder="Enter a word..."
               required style="width:45%; box-sizing:border-box;">
        <button type="submit" style="margin-left:0.3rem;">Add</button>
      </form>
    </section>
    {% endif %}

    {% if current_member.role.value == "organizer" and prompt.status.value == "active" %}
    <section style="margin-top:1rem; border-top:1px solid #ddd; padding-top:1rem;">
      <h3>Organizer controls</h3>
      <form method="post" action="/games/{{ game.id }}/session0/{{ prompt.id }}/mark-done-word-seeds" style="display:inline;">
        <button type="submit">Mark word seeds complete</button>
      </form>
      <form method="post" action="/games/{{ game.id }}/session0/{{ prompt.id }}/skip" style="display:inline; margin-left:0.5rem;">
        <button type="submit">Skip this prompt</button>
      </form>
    </section>
    {% endif %}

    {% if prompt.status.value == "skipped" %}
    <p style="margin-top:1rem;"><em>This prompt was skipped.</em></p>
    {% endif %}

    {% if prompt.status.value == "complete" %}
    <p style="margin-top:1rem;"><em>Word seeds have been configured.</em></p>
    {% endif %}

    {% elif prompt.is_safety_tools %}

    <!-- Safety Tools UI — replaces the normal contributions/synthesis flow -->
    <section>
      <h3>Lines <small style="font-weight:normal;">(hard limits — content that must not appear)</small></h3>
      {% set lines = safety_tools | selectattr("kind.value", "equalto", "line") | list %}
      {% if lines %}
      <ul>
        {% for t in lines %}
        <li>
          {{ t.description }}
          <small>— {{ t.user.display_name if t.user else "Anonymous" }}</small>
          {% if t.user_id == current_user.id or current_member.role.value == "organizer" %}
          <form method="post" action="/games/{{ game.id }}/safety-tools/{{ t.id }}/delete" style="display:inline; margin-left:0.4rem;">
            <button type="submit" style="font-size:0.75rem;">Remove</button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p><em>No lines set yet.</em></p>
      {% endif %}

      <h3>Veils <small style="font-weight:normal;">(fade to black — referenced but not depicted)</small></h3>
      {% set veils = safety_tools | selectattr("kind.value", "equalto", "veil") | list %}
      {% if veils %}
      <ul>
        {% for t in veils %}
        <li>
          {{ t.description }}
          <small>— {{ t.user.display_name if t.user else "Anonymous" }}</small>
          {% if t.user_id == current_user.id or current_member.role.value == "organizer" %}
          <form method="post" action="/games/{{ game.id }}/safety-tools/{{ t.id }}/delete" style="display:inline; margin-left:0.4rem;">
            <button type="submit" style="font-size:0.75rem;">Remove</button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p><em>No veils set yet.</em></p>
      {% endif %}
    </section>

    {% if prompt.status.value == "active" %}
    <section style="margin-top:1rem;">
      <h3>Add a line or veil</h3>
      <form method="post" action="/games/{{ game.id }}/safety-tools/add">
        <select name="kind" required style="margin-right:0.5rem;">
          <option value="line">Line (hard limit)</option>
          <option value="veil">Veil (fade to black)</option>
        </select>
        <input type="text" name="description" placeholder="Describe the content..."
               required style="width:55%; box-sizing:border-box;">
        <button type="submit" style="margin-left:0.3rem;">Add</button>
      </form>
    </section>
    {% endif %}

    {% if current_member.role.value == "organizer" and prompt.status.value == "active" %}
    <section style="margin-top:1rem; border-top:1px solid #ddd; padding-top:1rem;">
      <h3>Organizer controls</h3>
      <form method="post" action="/games/{{ game.id }}/session0/{{ prompt.id }}/mark-done" style="display:inline;">
        <button type="submit">Mark safety tools complete</button>
      </form>
      <form method="post" action="/games/{{ game.id }}/session0/{{ prompt.id }}/skip" style="display:inline; margin-left:0.5rem;">
        <button type="submit">Skip this prompt</button>
      </form>
    </section>
    {% endif %}

    {% if prompt.status.value == "skipped" %}
    <p style="margin-top:1rem;"><em>This prompt was skipped.</em></p>
    {% endif %}

    {% if prompt.status.value == "complete" %}
    <p style="margin-top:1rem;"><em>Safety tools have been set.</em></p>
    {% endif %}

    {% else %}

    <!-- Contributions -->
    <section>
      <h3>Contributions</h3>
      {% if responses %}
      <ul>
        {% for r in responses %}
        <li><strong>{{ r.user.display_name if r.user else "Anonymous" }}:</strong> {{ r.content }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <p><em>No contributions yet.</em></p>
      {% endif %}
    </section>

    <!-- My contribution form — only when prompt is active -->
    {% if prompt.status.value == "active" %}
    <section style="margin-top:1rem;">
      <h3>{% if my_response %}Update your contribution{% else %}Add your contribution{% endif %}</h3>
      <form method="post" action="/games/{{ game.id }}/session0/{{ prompt.id }}/respond">
        <textarea name="content" rows="4" style="width:100%; box-sizing:border-box;" required>{{ my_response.content if my_response else "" }}</textarea><br>
        <button type="submit" style="margin-top:0.3rem;">
          {% if my_response %}Update{% else %}Submit{% endif %}
        </button>
      </form>
    </section>
    {% endif %}

    <!-- Synthesis block -->
    {% if prompt.synthesis %}
    <section style="margin-top:1rem;">
      <h3>AI Synthesis</h3>
      <blockquote style="border-left:3px solid #ccc; padding-left:1rem; margin-left:0;">{{ prompt.synthesis }}</blockquote>

      {% if current_member.role.value == "organizer" and prompt.synthesis_accepted == false %}
      <div style="margin-top:0.5rem;">
        <form method="post" action="/games/{{ game.id }}/session0/{{ prompt.id }}/accept" style="display:inline;">
          <button type="submit">Accept synthesis</button>
        </form>
        <form method="post" action="/games/{{ game.id }}/session0/{{ prompt.id }}/regenerate" style="display:inline; margin-left:0.5rem;">
          <button type="submit">Regenerate</button>
        </form>
      </div>
      {% elif prompt.synthesis_accepted %}
      <p><em>Synthesis accepted.</em></p>
      {% endif %}
    </section>
    {% endif %}

    <!-- Organizer controls -->
    {% if current_member.role.value == "organizer" and prompt.status.value == "active" %}
    <section style="margin-top:1rem; border-top:1px solid #ddd; padding-top:1rem;">
      <h3>Organizer controls</h3>
      {% if not prompt.synthesis %}
      <form method="post" action="/games/{{ game.id }}/session0/{{ prompt.id }}/synthesize" style="display:inline;">
        <button type="submit">Synthesize contributions</button>
      </form>
      {% endif %}
      <form method="post" action="/games/{{ game.id }}/session0/{{ prompt.id }}/skip" style="display:inline; margin-left:0.5rem;">
        <button type="submit">Skip this prompt</button>
      </form>
    </section>
    {% endif %}

    {% if prompt.status.value == "skipped" %}
    <p style="margin-top:1rem;"><em>This prompt was skipped.</em></p>
    {% endif %}

    {% if prompt.status.value == "complete" %}
    <p style="margin-top:1rem;"><em>This prompt is complete.</em></p>
    {% endif %}

    {% endif %}

    <!-- Complete Session 0 / Generate World Document (organizer, all prompts done) -->
    {% if current_member.role.value == "organizer" and all_done %}
    <section style="margin-top:2rem; border-top:2px solid #333; padding-top:1rem;">
      <h3>Session 0 complete!</h3>
      <p>All prompts are done. Generate the world document and open an approval vote to start the game.</p>
      <form method="post" action="/games/{{ game.id }}/session0/complete">
        <button type="submit">Generate World Document &amp; Start Vote</button>
      </form>
    </section>
    {% endif %}

    <!-- Early exit: any member can propose ready to play -->
    <section style="margin-top:2rem; border-top:1px dashed #ccc; padding-top:1rem;">
      <h3>Early Exit</h3>
      <p>If the group is ready to start, any player can propose to skip remaining prompts and begin play.</p>
      <form method="post" action="/games/{{ game.id }}/session0/propose-ready">
        <button type="submit">Propose Ready to Play</button>
      </form>
    </section>

  </main>
</div>

<p style="margin-top:1.5rem;"><a href="/games/{{ game.id }}">&larr; Game Dashboard</a></p>
{% endblock %}
