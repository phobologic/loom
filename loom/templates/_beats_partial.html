{% if beats %}
<ol style="list-style:none; padding:0; margin:0;">
  {% for beat in beats %}
  <li style="margin-bottom:1.25rem; padding:0.75rem; border:1px solid {% if beat.status.value in ['proposed', 'challenged'] %}#e8a020{% else %}#ddd{% endif %}; border-radius:4px; background:{% if beat.status.value == 'challenged' %}#fff8ee{% elif beat.status.value == 'proposed' %}#fffbf0{% else %}#fff{% endif %};">
    <div style="font-size:0.85rem; color:#555; margin-bottom:0.4rem;">
      <strong>{{ beat.author.display_name if beat.author else "Unknown" }}</strong>
      &middot; {{ beat.significance.value | capitalize }}
      &middot; <em>{{ beat.status.value | capitalize }}</em>
      {% if beat.status.value == "proposed" %}
      <span style="color:#c07800; font-weight:bold;">[Pending vote]</span>
      {% elif beat.status.value == "challenged" %}
      <span style="color:#c04000; font-weight:bold;">[Challenged]</span>
      {% endif %}
    </div>
    {% for event in beat.events %}
    <div style="margin-top:0.4rem; padding:0.3rem 0.5rem; border-left:3px solid {% if event.type.value == 'ooc' %}#999{% else %}#4a7fc1{% endif %}; background:{% if event.type.value == 'ooc' %}#f5f5f5{% else %}#f8fbff{% endif %};">
      <span style="font-size:0.75rem; color:#888; text-transform:uppercase; letter-spacing:0.05em;">{{ event.type.value | replace("_", " ") }}</span>
      {% if event.type.value == "narrative" %}
      <p style="margin:0.2rem 0 0;">{{ event.content }}</p>
      {% elif event.type.value == "roll" %}
      <p style="margin:0.2rem 0 0;">
        Roll <code>{{ event.roll_notation }}</code>: <strong>{{ event.roll_result }}</strong>
        {% if event.content %}&mdash; {{ event.content }}{% endif %}
      </p>
      {% elif event.type.value == "oracle" %}
      <p style="margin:0.2rem 0 0;"><em>{{ event.oracle_query }}</em></p>
      {% if event.oracle_type == 'personal' %}
      <p style="font-size:0.8rem; color:#888; margin:0.1rem 0 0;">Personal oracle</p>
      {% endif %}
      {# Show selected interpretation highlighted, or full list for open discussion #}
      {% if event.oracle_selected_interpretation %}
      <div style="margin:0.4rem 0 0; padding:0.5rem 0.75rem; background:#e8f5e9; border:1px solid #4caf50; border-radius:4px;">
        <span style="font-size:0.75rem; color:#2e7d32; font-weight:bold; text-transform:uppercase; letter-spacing:0.04em;">Selected</span>
        <p style="margin:0.2rem 0 0;">{{ event.oracle_selected_interpretation }}</p>
      </div>
      {% elif event.interpretations %}
      <ol style="margin:0.25rem 0 0; padding-left:1.4rem;">
        {% for interp in event.interpretations %}
        <li style="margin-bottom:0.2rem;">{{ interp }}</li>
        {% endfor %}
      </ol>
      {% endif %}
      {# Oracle discussion panel (shown while unresolved) #}
      {% if not event.oracle_selected_interpretation and event.interpretations %}
      {% set oracle_vc = oracle_vote_counts.get(event.id, {}) if oracle_vote_counts is defined else {} %}
      {% set oracle_my_vote = oracle_my_votes.get(event.id) if oracle_my_votes is defined else None %}
      {% set is_invoker = (current_user_id is defined and beat.author_id == current_user_id) %}
      <div style="margin-top:0.75rem; padding:0.6rem 0.75rem; border:1px solid #c4a000; border-radius:4px; background:#fffdf0;">
        <p style="margin:0 0 0.4rem; font-size:0.85rem; font-weight:bold; color:#7a5c00;">
          Oracle &mdash; awaiting selection
          {% if event.oracle_type == 'personal' %}(personal){% endif %}
        </p>

        {# World oracle: show vote tallies and vote form for non-invokers #}
        {% if event.oracle_type != 'personal' %}
        {% if oracle_vc %}
        <p style="font-size:0.82rem; color:#555; margin:0 0 0.35rem;">
          Votes:
          {% for idx in range(event.interpretations | length) %}
          #{{ idx + 1 }}: {{ oracle_vc.get(idx, 0) }}{% if not loop.last %} &middot; {% endif %}
          {% endfor %}
          {% if oracle_vc.get(-1, 0) %}&middot; alt: {{ oracle_vc.get(-1, 0) }}{% endif %}
        </p>
        {% endif %}

        {# Vote history #}
        {% set all_votes = event.oracle_interpretation_votes if event.oracle_interpretation_votes is defined else [] %}
        {% if all_votes %}
        <ul style="margin:0 0 0.4rem; padding-left:1.2rem; font-size:0.82rem;">
          {% for v in all_votes %}
          <li>
            <strong>{{ v.voter.display_name if v.voter else "Anonymous" }}:</strong>
            {% if v.interpretation_index == -1 %}
            proposes alternative &mdash; <em>{{ v.alternative_text }}</em>
            {% else %}
            option #{{ v.interpretation_index + 1 }}
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% endif %}

        {# Vote form for non-invoker who hasn't voted yet #}
        {% if not is_invoker %}
          {% if not oracle_my_vote %}
          <form method="post" action="/games/{{ game.id }}/oracle/events/{{ event.id }}/vote" style="margin-top:0.35rem;">
            <fieldset style="border:none; padding:0; margin:0;">
              <div style="font-size:0.82rem; color:#555; margin-bottom:0.3rem;">Vote for your preferred interpretation:</div>
              {% for interp in event.interpretations %}
              <label style="display:block; margin:0.15rem 0; font-size:0.83rem;">
                <input type="radio" name="interpretation_index" value="{{ loop.index0 }}" required>
                #{{ loop.index }} &mdash; {{ interp }}
              </label>
              {% endfor %}
              <label style="display:block; margin:0.35rem 0 0.1rem; font-size:0.83rem;">
                <input type="radio" name="interpretation_index" value="-1">
                Propose alternative:
              </label>
              <textarea name="alternative_text" rows="2"
                style="width:100%; max-width:32rem; font-size:0.82rem; margin-top:0.15rem;"
                placeholder="Describe your alternative interpretation"></textarea>
              <button type="submit" style="margin-top:0.35rem; font-size:0.83rem;">Submit vote</button>
            </fieldset>
          </form>
          {% else %}
          <p style="font-size:0.83rem; margin:0 0 0.3rem;">
            Your vote:
            {% if oracle_my_vote.interpretation_index == -1 %}
            <strong>alternative</strong> &mdash; <em>{{ oracle_my_vote.alternative_text }}</em>
            {% else %}
            <strong>option #{{ oracle_my_vote.interpretation_index + 1 }}</strong>
            {% endif %}
          </p>
          {% endif %}
        {% endif %}
        {% endif %}{# end world oracle vote section #}

        {# Comment thread #}
        {% set oracle_coms = event.oracle_comments if event.oracle_comments is defined else [] %}
        {% if oracle_coms %}
        <div style="margin-top:0.5rem; border-top:1px solid #e0d080; padding-top:0.4rem;">
          <div style="font-size:0.78rem; color:#888; margin-bottom:0.25rem; text-transform:uppercase; letter-spacing:0.04em;">Comments</div>
          <ul style="margin:0; padding-left:1.1rem; font-size:0.82rem;">
            {% for c in oracle_coms %}
            <li style="margin-bottom:0.2rem;">
              <strong>{{ c.author.display_name if c.author else "Anonymous" }}:</strong> {{ c.text }}
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {# Comment form (all members) #}
        <form method="post" action="/games/{{ game.id }}/oracle/events/{{ event.id }}/comment" style="margin-top:0.4rem; border-top:1px solid #e0d080; padding-top:0.4rem;">
          <input type="text" name="text" placeholder="Add a comment…"
            style="width:100%; max-width:28rem; font-size:0.82rem;" required>
          <button type="submit" style="font-size:0.82rem; margin-top:0.2rem;">Comment</button>
        </form>

        {# Invoker selection panel #}
        {% if is_invoker %}
        <div style="margin-top:0.6rem; border-top:1px solid #e0d080; padding-top:0.5rem;">
          <div style="font-size:0.83rem; font-weight:bold; color:#7a5c00; margin-bottom:0.35rem;">Select interpretation</div>
          {% for interp in event.interpretations %}
          <form method="post" action="/games/{{ game.id }}/oracle/events/{{ event.id }}/select"
              style="margin-bottom:0.3rem; display:flex; align-items:baseline; gap:0.5rem;">
            <input type="hidden" name="interpretation_index" value="{{ loop.index0 }}">
            <button type="submit" style="font-size:0.8rem; white-space:nowrap;">Select #{{ loop.index }}</button>
            <span style="font-size:0.83rem;">{{ interp }}</span>
          </form>
          {% endfor %}
          {# Custom selection #}
          <form method="post" action="/games/{{ game.id }}/oracle/events/{{ event.id }}/select"
              style="margin-top:0.3rem;">
            <input type="hidden" name="interpretation_index" value="-1">
            <div style="font-size:0.82rem; color:#555; margin-bottom:0.2rem;">Or select a custom interpretation:</div>
            <textarea name="alternative_text" rows="2"
              style="width:100%; max-width:32rem; font-size:0.82rem;"
              placeholder="Type the chosen interpretation text…"></textarea>
            <button type="submit" style="font-size:0.8rem; margin-top:0.25rem;">Select custom</button>
          </form>
          {# Tie-break auto-resolve (only meaningful if there are votes) #}
          {% set total_votes = event.oracle_interpretation_votes | length if event.oracle_interpretation_votes is defined else 0 %}
          {% if total_votes > 0 %}
          <form method="post" action="/games/{{ game.id }}/oracle/events/{{ event.id }}/select"
              style="margin-top:0.4rem;">
            <input type="hidden" name="interpretation_index" value="-2">
            <button type="submit" style="font-size:0.8rem; background:#f0e8c0; border:1px solid #c4a000;">
              &#9861; Let fate decide (apply tie-breaking)
            </button>
          </form>
          {% endif %}
        </div>
        {% endif %}

      </div>
      {% endif %}{# end unresolved oracle discussion #}
      {% elif event.type.value == "fortune_roll" %}
      <p style="margin:0.2rem 0 0;">
        Odds: {{ event.fortune_roll_odds }} &rarr; <strong>{{ event.fortune_roll_result }}</strong>
        {% if event.fortune_roll_tension %}&mdash; Tension: {{ event.fortune_roll_tension }}{% endif %}
      </p>
      {% elif event.type.value == "ooc" %}
      <p style="margin:0.2rem 0 0; color:#555;">{{ event.content }}</p>
      {% endif %}
      {% if event.word_seed_action or event.word_seed_descriptor %}
      <p style="margin:0.15rem 0 0; font-size:0.8rem; color:#777;">
        Seeds: {{ event.word_seed_action }}{% if event.word_seed_action and event.word_seed_descriptor %} / {% endif %}{{ event.word_seed_descriptor }}
      </p>
      {% endif %}
    </div>
    {% endfor %}
    {% if not beat.events %}
    <p style="margin:0.25rem 0 0; color:#aaa; font-style:italic; font-size:0.85rem;">(no events)</p>
    {% endif %}

    {# Voting panel for major beats pending approval #}
    {% if beat_proposals is defined %}
    {% set proposal = beat_proposals.get(beat.id) %}
    {% if proposal and proposal.status.value == 'open' %}
    <div style="margin-top:0.75rem; padding:0.6rem 0.75rem; border:1px solid #e8a020; border-radius:4px; background:#fffbf0;">
      <p style="margin:0 0 0.35rem; font-size:0.85rem; font-weight:bold; color:#c07800;">
        Major beat &mdash; awaiting vote
      </p>

      {% if proposal.expires_at and now is defined %}
      {% set secs = ((proposal.expires_at - now).total_seconds()) | int %}
      <p style="font-size:0.8rem; color:#888; margin:0 0 0.35rem;">
        Auto-approves in
        {% if secs > 3600 %}~{{ (secs / 3600) | int }}h
        {% elif secs > 60 %}~{{ (secs / 60) | int }}m
        {% else %}imminently{% endif %}
      </p>
      {% endif %}

      {% if beat_vote_counts is defined %}
      {% set vc = beat_vote_counts.get(beat.id, {}) %}
      <p style="font-size:0.85rem; margin:0 0 0.35rem;">
        {{ vc.get('yes', 0) }} yes &middot; {{ vc.get('no', 0) }} no &middot; {{ vc.get('suggest', 0) }} suggestion(s)
      </p>
      {% endif %}

      {% if proposal.votes %}
      <ul style="margin:0 0 0.5rem; padding-left:1.2rem; font-size:0.85rem;">
        {% for v in proposal.votes %}
        <li>
          <strong>{{ v.voter.display_name if v.voter else "Anonymous" }}:</strong>
          {{ v.choice.value | replace("_", " ") | capitalize }}
          {% if v.suggestion %}<br><em style="color:#555;">{{ v.suggestion }}</em>{% endif %}
        </li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if beat_my_votes is defined %}
      {% set my_vote = beat_my_votes.get(beat.id) %}
      {% if not my_vote %}
      <form method="post" action="/games/{{ game.id }}/proposals/{{ proposal.id }}/vote">
        <fieldset style="border:none; padding:0; margin:0;">
          <label style="display:block; margin:0.2rem 0; font-size:0.85rem;">
            <input type="radio" name="choice" value="yes" required> Yes, approve
          </label>
          <label style="display:block; margin:0.2rem 0; font-size:0.85rem;">
            <input type="radio" name="choice" value="no"> No, reject
          </label>
          <label style="display:block; margin:0.2rem 0; font-size:0.85rem;">
            <input type="radio" name="choice" value="suggest_modification"> Suggest modification
          </label>
          <div style="margin-top:0.4rem;">
            <textarea name="suggestion" rows="2" style="width:100%; max-width:32rem; font-size:0.85rem;"
              placeholder="Required for suggest modification"></textarea>
          </div>
          <button type="submit" style="margin-top:0.4rem; font-size:0.85rem;">Cast vote</button>
        </fieldset>
      </form>
      {% else %}
      <p style="font-size:0.85rem; margin:0;">
        Your vote: <strong>{{ my_vote.choice.value | replace("_", " ") | capitalize }}</strong>
        {% if my_vote.suggestion %} &mdash; <em>{{ my_vote.suggestion }}</em>{% endif %}
      </p>
      {% endif %}
      {% endif %}
    </div>
    {% elif proposal and proposal.status.value == 'approved' and beat.status.value == 'canon' %}
      {% if proposal.votes | length == 1 %}
      <p style="font-size:0.8rem; color:#2a7a2a; margin:0.35rem 0 0;">
        &#10003; Auto-approved (silence timer)
      </p>
      {% endif %}
    {% endif %}
    {% endif %}

  </li>
  {% endfor %}
</ol>
{% else %}
<p style="color:#888; font-style:italic;">No beats yet. Submit the first beat to begin the scene.</p>
{% endif %}
