{% if beats %}
<ol style="list-style:none; padding:0; margin:0;">
  {% for beat in beats %}
  <li style="margin-bottom:1.25rem; padding:0.75rem; border:1px solid {% if beat.status.value in ['proposed', 'challenged'] %}#e8a020{% else %}#ddd{% endif %}; border-radius:4px; background:{% if beat.status.value == 'challenged' %}#fff8ee{% elif beat.status.value == 'proposed' %}#fffbf0{% else %}#fff{% endif %};">
    <div style="font-size:0.85rem; color:#555; margin-bottom:0.4rem;">
      <strong>{{ beat.author.display_name if beat.author else "Unknown" }}</strong>
      &middot; {{ beat.significance.value | capitalize }}
      &middot; <em>{{ beat.status.value | capitalize }}</em>
      {% if beat.status.value == "proposed" %}
      <span style="color:#c07800; font-weight:bold;">[Pending vote]</span>
      {% elif beat.status.value == "challenged" %}
      <span style="color:#c04000; font-weight:bold;">[Challenged]</span>
      {% endif %}
    </div>
    {% for event in beat.events %}
    <div style="margin-top:0.4rem; padding:0.3rem 0.5rem; border-left:3px solid {% if event.type.value == 'ooc' %}#999{% else %}#4a7fc1{% endif %}; background:{% if event.type.value == 'ooc' %}#f5f5f5{% else %}#f8fbff{% endif %};">
      <span style="font-size:0.75rem; color:#888; text-transform:uppercase; letter-spacing:0.05em;">{{ event.type.value | replace("_", " ") }}</span>
      {% if event.type.value == "narrative" %}
      <p style="margin:0.2rem 0 0;">{{ event.content }}</p>
      {% elif event.type.value == "roll" %}
      <p style="margin:0.2rem 0 0;">
        Roll <code>{{ event.roll_notation }}</code>: <strong>{{ event.roll_result }}</strong>
        {% if event.content %}&mdash; {{ event.content }}{% endif %}
      </p>
      {% elif event.type.value == "oracle" %}
      <p style="margin:0.2rem 0 0;"><em>{{ event.oracle_query }}</em></p>
      {% if event.interpretations %}
      <ul style="margin:0.25rem 0 0; padding-left:1.2rem;">
        {% for interp in event.interpretations %}
        <li>{{ interp }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% elif event.type.value == "fortune_roll" %}
      <p style="margin:0.2rem 0 0;">
        Odds: {{ event.fortune_roll_odds }} &rarr; <strong>{{ event.fortune_roll_result }}</strong>
        {% if event.fortune_roll_tension %}&mdash; Tension: {{ event.fortune_roll_tension }}{% endif %}
      </p>
      {% elif event.type.value == "ooc" %}
      <p style="margin:0.2rem 0 0; color:#555;">{{ event.content }}</p>
      {% endif %}
      {% if event.word_seed_action or event.word_seed_descriptor %}
      <p style="margin:0.15rem 0 0; font-size:0.8rem; color:#777;">
        Seeds: {{ event.word_seed_action }}{% if event.word_seed_action and event.word_seed_descriptor %} / {% endif %}{{ event.word_seed_descriptor }}
      </p>
      {% endif %}
    </div>
    {% endfor %}
    {% if not beat.events %}
    <p style="margin:0.25rem 0 0; color:#aaa; font-style:italic; font-size:0.85rem;">(no events)</p>
    {% endif %}

    {# Voting panel for major beats pending approval #}
    {% if beat_proposals is defined %}
    {% set proposal = beat_proposals.get(beat.id) %}
    {% if proposal and proposal.status.value == 'open' %}
    <div style="margin-top:0.75rem; padding:0.6rem 0.75rem; border:1px solid #e8a020; border-radius:4px; background:#fffbf0;">
      <p style="margin:0 0 0.35rem; font-size:0.85rem; font-weight:bold; color:#c07800;">
        Major beat &mdash; awaiting vote
      </p>

      {% if proposal.expires_at and now is defined %}
      {% set secs = ((proposal.expires_at - now).total_seconds()) | int %}
      <p style="font-size:0.8rem; color:#888; margin:0 0 0.35rem;">
        Auto-approves in
        {% if secs > 3600 %}~{{ (secs / 3600) | int }}h
        {% elif secs > 60 %}~{{ (secs / 60) | int }}m
        {% else %}imminently{% endif %}
      </p>
      {% endif %}

      {% if beat_vote_counts is defined %}
      {% set vc = beat_vote_counts.get(beat.id, {}) %}
      <p style="font-size:0.85rem; margin:0 0 0.35rem;">
        {{ vc.get('yes', 0) }} yes &middot; {{ vc.get('no', 0) }} no &middot; {{ vc.get('suggest', 0) }} suggestion(s)
      </p>
      {% endif %}

      {% if proposal.votes %}
      <ul style="margin:0 0 0.5rem; padding-left:1.2rem; font-size:0.85rem;">
        {% for v in proposal.votes %}
        <li>
          <strong>{{ v.voter.display_name if v.voter else "Anonymous" }}:</strong>
          {{ v.choice.value | replace("_", " ") | capitalize }}
          {% if v.suggestion %}<br><em style="color:#555;">{{ v.suggestion }}</em>{% endif %}
        </li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if beat_my_votes is defined %}
      {% set my_vote = beat_my_votes.get(beat.id) %}
      {% if not my_vote %}
      <form method="post" action="/games/{{ game.id }}/proposals/{{ proposal.id }}/vote">
        <fieldset style="border:none; padding:0; margin:0;">
          <label style="display:block; margin:0.2rem 0; font-size:0.85rem;">
            <input type="radio" name="choice" value="yes" required> Yes, approve
          </label>
          <label style="display:block; margin:0.2rem 0; font-size:0.85rem;">
            <input type="radio" name="choice" value="no"> No, reject
          </label>
          <label style="display:block; margin:0.2rem 0; font-size:0.85rem;">
            <input type="radio" name="choice" value="suggest_modification"> Suggest modification
          </label>
          <div style="margin-top:0.4rem;">
            <textarea name="suggestion" rows="2" style="width:100%; max-width:32rem; font-size:0.85rem;"
              placeholder="Required for suggest modification"></textarea>
          </div>
          <button type="submit" style="margin-top:0.4rem; font-size:0.85rem;">Cast vote</button>
        </fieldset>
      </form>
      {% else %}
      <p style="font-size:0.85rem; margin:0;">
        Your vote: <strong>{{ my_vote.choice.value | replace("_", " ") | capitalize }}</strong>
        {% if my_vote.suggestion %} &mdash; <em>{{ my_vote.suggestion }}</em>{% endif %}
      </p>
      {% endif %}
      {% endif %}
    </div>
    {% elif proposal and proposal.status.value == 'approved' and beat.status.value == 'canon' %}
      {% if proposal.votes | length == 1 %}
      <p style="font-size:0.8rem; color:#2a7a2a; margin:0.35rem 0 0;">
        &#10003; Auto-approved (silence timer)
      </p>
      {% endif %}
    {% endif %}
    {% endif %}

  </li>
  {% endfor %}
</ol>
{% else %}
<p style="color:#888; font-style:italic;">No beats yet. Submit the first beat to begin the scene.</p>
{% endif %}
